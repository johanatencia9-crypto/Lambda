<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RPATranslatorLambda.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HelloWorldFunction</a> &gt; <a href="index.source.html" class="el_package">helloworld</a> &gt; <span class="el_source">RPATranslatorLambda.java</span></div><h1>RPATranslatorLambda.java</h1><pre class="source lang-java linenums">package helloworld;

import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.LambdaLogger;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import Model.Evento;
import Model.InputQueen;
import Model.OutputResponse;
import utils.Servicio;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

<span class="fc" id="L20">public class RPATranslatorLambda implements RequestHandler&lt;Map&lt;String, Object&gt;, String&gt; {</span>

<span class="fc" id="L22">    private static final ObjectMapper MAPPER = new ObjectMapper();</span>
    private static LambdaLogger logger;

    @Override
    public String handleRequest(Map&lt;String, Object&gt; input, Context context) {
<span class="fc" id="L27">        logger = context.getLogger();</span>

        try {
<span class="fc" id="L30">            logger.log(&quot;Evento raw: &quot; + MAPPER.writeValueAsString(input) + &quot;\n&quot;);</span>
<span class="nc" id="L31">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L32">            throw new RuntimeException(e);</span>
<span class="fc" id="L33">        }</span>

        try {
            // ✅ PRIORIDAD 1: Extrae Records (case-insensitive)
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">            Object recordsObj = input.get(&quot;Records&quot;) != null ? input.get(&quot;Records&quot;) : input.get(&quot;records&quot;);</span>
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">            if (recordsObj instanceof List) {</span>
<span class="nc" id="L40">                List&lt;Map&lt;String, Object&gt;&gt; records = (List&lt;Map&lt;String, Object&gt;&gt;) recordsObj;</span>
<span class="nc" id="L41">                logger.log(&quot;✅ SQS Batch detectado: &quot; + records.size() + &quot; records\n&quot;);</span>

<span class="nc bnc" id="L43" title="All 2 branches missed.">                for (Map&lt;String, Object&gt; record : records) {</span>
<span class="nc" id="L44">                    procesarRecord(record);</span>
<span class="nc" id="L45">                }</span>
<span class="nc" id="L46">                return &quot;✅ Batch procesado: &quot; + records.size();</span>
            }

            // ✅ PRIORIDAD 2: Fallback directo (no SQS)
<span class="fc" id="L50">            logger.log(&quot;No Records → JSON directo\n&quot;);</span>
<span class="fc" id="L51">            InputQueen directEvent = safeDeserialize(MAPPER.writeValueAsString(input), InputQueen.class);</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">            if (directEvent != null) {</span>
<span class="nc" id="L53">                processEventSafe(directEvent);</span>
<span class="nc" id="L54">                return &quot;✅ Directo OK&quot;;</span>
            }

            // ❌ Fallback final: trata como single body
<span class="nc" id="L58">            logger.log(&quot;Intentando como single body\n&quot;);</span>
<span class="nc" id="L59">            InputQueen singleBody = safeDeserialize(MAPPER.writeValueAsString(input), InputQueen.class);</span>
<span class="nc" id="L60">            processEventSafe(singleBody);</span>

<span class="fc" id="L62">        } catch (Exception e) {</span>
<span class="fc" id="L63">            logger.log(&quot;❌ CRÍTICO: &quot; + e.getMessage() + &quot;\n&quot;);</span>
<span class="fc" id="L64">            throw new RuntimeException(e);</span>
<span class="nc" id="L65">        }</span>

<span class="nc" id="L67">        return &quot;✅ OK&quot;;</span>
    }

    private void procesarRecord(Map&lt;String, Object&gt; record) throws Exception {
<span class="nc" id="L71">        String body = (String) record.get(&quot;body&quot;);</span>
<span class="nc" id="L72">        logger.log(&quot;Record body: &quot; + body + &quot;\n&quot;);</span>

<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (body == null || body.isBlank()) {</span>
<span class="nc" id="L75">            throw new IllegalArgumentException(&quot;Body SQS vacío&quot;);</span>
        }

<span class="nc" id="L78">        InputQueen eventModel = MAPPER.readValue(body, InputQueen.class);</span>
<span class="nc" id="L79">        processEventSafe(eventModel);</span>
<span class="nc" id="L80">    }</span>

    private void processEventSafe(InputQueen inputQueen) {
<span class="fc" id="L83">        OutputResponse output = new OutputResponse();</span>
        try {
<span class="nc" id="L85">            processEvent(inputQueen, output);</span>
<span class="nc" id="L86">            logger.log(&quot;✅ Evento procesado correctamente\n&quot;);</span>
<span class="fc" id="L87">        } catch (Exception e) {</span>
<span class="fc" id="L88">            logger.log(&quot;❌ Error procesando evento de negocio: &quot; + e.getMessage() + &quot;\n&quot;);</span>
<span class="fc" id="L89">            throw new RuntimeException(e);</span>
<span class="nc" id="L90">        }</span>
<span class="nc" id="L91">    }</span>

    private void processEvent(InputQueen inputQueen, OutputResponse output) throws Exception {
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">        if (inputQueen == null || inputQueen.getComando() == null) {</span>
<span class="nc" id="L95">            logger.log(&quot;Error: el input o el comando es nulo.&quot;);</span>
<span class="nc" id="L96">            output.setMensaje(&quot;Input o comando nulo&quot;);</span>
<span class="nc" id="L97">            return;</span>
        }

<span class="fc" id="L100">        Map&lt;String, Object&gt; comando = inputQueen.getComando();</span>

        // Construimos el Evento a partir del comando
<span class="fc" id="L103">        Evento evento = new Evento();</span>
<span class="fc" id="L104">        evento.setId((String) comando.get(&quot;id&quot;));</span>
<span class="fc" id="L105">        evento.setIdTrazabilidad((String) comando.get(&quot;idTrazabilidad&quot;));</span>
<span class="fc" id="L106">        evento.setNombre((String) comando.get(&quot;nombre&quot;));</span>

<span class="fc" id="L108">        Object aplicacion = comando.get(&quot;aplicacionEmisora&quot;);</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if (aplicacion instanceof Map) {</span>
<span class="fc" id="L110">            evento.setAplicacionEmisora((Map&lt;String, Object&gt;) aplicacion);</span>
        }

<span class="fc" id="L113">        Object payloadObj = comando.get(&quot;payload&quot;);</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (payloadObj instanceof Map) {</span>
<span class="fc" id="L115">            evento.setPayload((Map&lt;String, Object&gt;) payloadObj);</span>
        }

<span class="fc" id="L118">        logger.log(&quot;Evento recibido: &quot; + evento.getNombre() + &quot;, ID: &quot; + evento.getId() + &quot;\n&quot;);</span>

<span class="fc" id="L120">        JsonNode payload = MAPPER.valueToTree(evento.getPayload());</span>

<span class="pc bpc" id="L122" title="3 of 6 branches missed.">        if (payload != null &amp;&amp; !payload.isNull() &amp;&amp; payload.size() &gt; 0) {</span>
<span class="fc" id="L123">            logger.log(&quot;Payload recibido: &quot; + payload.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L124">            Map&lt;String, Object&gt; payloadMap = MAPPER.convertValue(payload, Map.class);</span>
<span class="fc" id="L125">            output.setPayload(payloadMap);</span>

<span class="fc" id="L127">            String jsonBody = MAPPER.writeValueAsString(payload);</span>
            // Servicio.llamarServicio(urlServicio, jsonBody, logger);

<span class="fc" id="L130">            output.setMensaje(&quot;Payload procesado correctamente.&quot;);</span>
<span class="fc" id="L131">        } else {</span>
<span class="nc" id="L132">            logger.log(&quot;Payload no encontrado, enviando evento completo.\n&quot;);</span>
<span class="nc" id="L133">            JsonNode eventoCompleto = MAPPER.valueToTree(evento);</span>
<span class="nc" id="L134">            String jsonBody = MAPPER.writeValueAsString(eventoCompleto);</span>
            // Servicio.llamarServicio(urlServicio, jsonBody, logger);

<span class="nc" id="L137">            Map&lt;String, Object&gt; eventoCompletoMap = MAPPER.convertValue(eventoCompleto, Map.class);</span>
<span class="nc" id="L138">            output.setPayload(eventoCompletoMap);</span>

<span class="nc" id="L140">            output.setMensaje(&quot;Evento completo procesado.&quot;);</span>
        }

        // Ejemplo de token (opcional según tu lógica)
<span class="fc" id="L144">        Map&lt;String,Object&gt; headersToken=new HashMap&lt;&gt;();</span>
<span class="fc" id="L145">        headersToken.put(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span>
<span class="fc" id="L146">        headersToken.put(&quot;scope&quot;,&quot;OR.Queues&quot;);</span>

<span class="fc" id="L148">        String clientId = System.getenv(&quot;CLIENT_ID&quot;);</span>
<span class="fc" id="L149">        String clientSecret = System.getenv(&quot;CLIENT_SECRET&quot;);</span>

<span class="pc" id="L151">        String bodyToken = String.format(</span>
                &quot;grant_type=client_credentials&amp;scope=%s&amp;client_id=%s&amp;client_secret=%s&quot;,
<span class="fc" id="L153">                URLEncoder.encode(&quot;OR.Queues&quot;, StandardCharsets.UTF_8),</span>
<span class="nc" id="L154">                URLEncoder.encode(clientId, StandardCharsets.UTF_8),</span>
<span class="nc" id="L155">                URLEncoder.encode(clientSecret, StandardCharsets.UTF_8)</span>
        );

<span class="nc" id="L158">        String urlToken = System.getenv(&quot;URL_SERVICIO_TOKEN&quot;);</span>
<span class="nc" id="L159">        String urlServicio = System.getenv(&quot;URL_SERVICIO_EXTERNO&quot;);</span>

<span class="nc" id="L161">        String token = Servicio.obtenerToken(urlToken, logger, headersToken, bodyToken);</span>
<span class="nc" id="L162">        logger.log(&quot;Token obtenido: &quot; + token + &quot;\n&quot;);</span>
<span class="nc" id="L163">    }</span>

    private &lt;T&gt; T safeDeserialize(String json, Class&lt;T&gt; clazz) {
        try {
<span class="fc" id="L167">            return MAPPER.readValue(json, clazz);</span>
<span class="nc" id="L168">        } catch (Exception e) {</span>
<span class="nc" id="L169">            logger.log(&quot;Deserialización falló [&quot; + clazz.getSimpleName() + &quot;]: &quot; + e.getMessage() + &quot;\nJSON: &quot; + json);</span>
<span class="nc" id="L170">            return null;</span>
        }
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>