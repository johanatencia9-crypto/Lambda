<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RPATranslatorLambda.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HelloWorldFunction</a> &gt; <a href="index.source.html" class="el_package">helloworld</a> &gt; <span class="el_source">RPATranslatorLambda.java</span></div><h1>RPATranslatorLambda.java</h1><pre class="source lang-java linenums">package helloworld;

import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.LambdaLogger;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.List;
import java.util.Map;
import utils.Servicio;
import Model.Evento;
import Model.InputQueen;
import Model.OutputResponse;

<span class="fc" id="L15">public class RPATranslatorLambda implements RequestHandler&lt;Map&lt;String, Object&gt;, String&gt; {</span>

<span class="fc" id="L17">    private static final ObjectMapper MAPPER = new ObjectMapper();</span>
    private static LambdaLogger logger;

    @Override

    public String handleRequest(Map&lt;String, Object&gt; input, Context context) {
<span class="fc" id="L23">        logger = context.getLogger();</span>
        try {
<span class="fc" id="L25">            logger.log(&quot;Evento raw: &quot; + MAPPER.writeValueAsString(input) + &quot;\n&quot;);</span>
<span class="nc" id="L26">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L27">            throw new RuntimeException(e);</span>
<span class="fc" id="L28">        }</span>

        try {
            // ✅ PRIORIDAD 1: Extrae Records (case-insensitive)
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="pc bpc" id="L33" title="1 of 2 branches missed.">            Object recordsObj = input.get(&quot;Records&quot;) != null ? input.get(&quot;Records&quot;) : input.get(&quot;records&quot;);</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">            if (recordsObj instanceof List) {</span>
<span class="nc" id="L35">                List&lt;Map&lt;String, Object&gt;&gt; records = (List&lt;Map&lt;String, Object&gt;&gt;) recordsObj;</span>
<span class="nc" id="L36">                logger.log(&quot;✅ SQS Batch detectado: &quot; + records.size() + &quot; records\n&quot;);</span>

<span class="nc bnc" id="L38" title="All 2 branches missed.">                for (Map&lt;String, Object&gt; record : records) {</span>
<span class="nc" id="L39">                    procesarRecord(record);</span>
<span class="nc" id="L40">                }</span>
<span class="nc" id="L41">                return &quot;✅ Batch procesado: &quot; + records.size();</span>
            }

            // ✅ PRIORIDAD 2: Fallback directo (no SQS)
<span class="fc" id="L45">            logger.log(&quot;No Records → JSON directo\n&quot;);</span>
<span class="fc" id="L46">            InputQueen directEvent = safeDeserialize(MAPPER.writeValueAsString(input), InputQueen.class);</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if (directEvent != null) {</span>
<span class="fc" id="L48">                processEventSafe(directEvent);</span>
<span class="fc" id="L49">                return &quot;✅ Directo OK&quot;;</span>
            }

            // ❌ Fallback final: trata como single body
<span class="nc" id="L53">            logger.log(&quot;Intentando como single body\n&quot;);</span>
<span class="nc" id="L54">            InputQueen singleBody = safeDeserialize(MAPPER.writeValueAsString(input), InputQueen.class);</span>
<span class="nc" id="L55">            processEventSafe(singleBody);</span>

<span class="nc" id="L57">        } catch (Exception e) {</span>
<span class="nc" id="L58">            logger.log(&quot;❌ CRÍTICO: &quot; + e.getMessage() + &quot;\n&quot;);</span>
<span class="nc" id="L59">            throw new RuntimeException(e);</span>
<span class="nc" id="L60">        }</span>
<span class="nc" id="L61">        return &quot;✅ OK&quot;;</span>
    }


    private void procesarRecord(Map&lt;String, Object&gt; record) throws Exception {
<span class="nc" id="L66">        String body = (String) record.get(&quot;body&quot;);</span>
<span class="nc" id="L67">        logger.log(&quot;Record body: &quot; + body + &quot;\n&quot;);</span>

<span class="nc bnc" id="L69" title="All 4 branches missed.">        if (body == null || body.isBlank()) {</span>
<span class="nc" id="L70">            throw new IllegalArgumentException(&quot;Body SQS vacío&quot;);</span>
        }

<span class="nc" id="L73">        InputQueen eventModel = MAPPER.readValue(body, InputQueen.class);</span>
<span class="nc" id="L74">        processEventSafe(eventModel);</span>
<span class="nc" id="L75">    }</span>

    private void processEventSafe(InputQueen inputQueen) {
        try {
<span class="fc" id="L79">            processEvent(inputQueen);</span>
<span class="fc" id="L80">            logger.log(&quot;Evento procesado correctamente\n&quot;);</span>
<span class="nc" id="L81">        } catch (Exception e) {</span>
<span class="nc" id="L82">            logger.log(&quot;❌ Error procesando evento de negocio: &quot; + e.getMessage() + &quot;\n&quot;);</span>
            // Si quieres retry de SQS, relanza
<span class="nc" id="L84">            throw new RuntimeException(e);</span>
<span class="fc" id="L85">        }</span>
<span class="fc" id="L86">    }</span>

    private void processEvent(InputQueen inputQueen) throws Exception {

<span class="pc bpc" id="L90" title="2 of 4 branches missed.">        if (inputQueen == null || inputQueen.getEvento() == null) {</span>
<span class="nc" id="L91">            throw new IllegalArgumentException(&quot;Input o evento nulo&quot;);</span>
        }

<span class="fc" id="L94">        Evento evento = inputQueen.getEvento();</span>
<span class="fc" id="L95">        logger.log(&quot;Evento recibido: &quot; + evento.getNombre() + &quot;, ID: &quot; + evento.getId() + &quot;\n&quot;);</span>

<span class="fc" id="L97">        OutputResponse output = new OutputResponse();</span>
<span class="fc" id="L98">        Object payload = evento.getPayload();</span>
        String jsonBody;

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (payload != null) {</span>
<span class="fc" id="L102">             jsonBody = MAPPER.writeValueAsString(payload);</span>

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (jsonBody.equals(&quot;{}&quot;)) {</span>
<span class="nc" id="L105">                logger.log(&quot;Payload detectado como vacío, enviando evento completo&quot;);</span>
<span class="nc" id="L106">                jsonBody = MAPPER.writeValueAsString(evento);</span>
            } else {
<span class="fc" id="L108">                logger.log(&quot;Payload recibido: &quot; + jsonBody + &quot;\n&quot;);</span>
            }

            // Llamada a servicio

        } else {
<span class="nc" id="L114">            logger.log(&quot;Payload es null, enviando evento completo\n&quot;);</span>
<span class="nc" id="L115">            jsonBody = MAPPER.writeValueAsString(evento);</span>



        }


        // Llamada a servicio externo
<span class="fc" id="L123">        String urlServicio = System.getenv(&quot;URL_SERVICIO_EXTERNO&quot;);</span>
<span class="fc" id="L124">        Servicio.llamarServicio(urlServicio, jsonBody, logger);</span>
<span class="fc" id="L125">        output.setPayload((Map&lt;String, Object&gt;) payload);</span>

<span class="fc" id="L127">        output.setMensaje(&quot;Evento procesado correctamente&quot;);</span>
<span class="fc" id="L128">    }</span>
    private &lt;T&gt; T safeDeserialize(String json, Class&lt;T&gt; clazz) {
        try {
<span class="fc" id="L131">            return MAPPER.readValue(json, clazz);</span>
<span class="nc" id="L132">        } catch (Exception e) {</span>
<span class="nc" id="L133">            logger.log(&quot;Deserialización falló [&quot; + clazz.getSimpleName() + &quot;]: &quot; + e.getMessage() + &quot;\nJSON: &quot; + json);</span>
<span class="nc" id="L134">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>